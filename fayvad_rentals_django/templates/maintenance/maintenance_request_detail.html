{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li><a href="{% url 'dashboard:dashboard_overview' %}" class="text-gray-700 hover:text-blue-900">Dashboard</a></li>
        <li><span class="text-gray-500">/</span></li>
        <li><a href="{% url 'maintenance:maintenance_request_list' %}" class="text-gray-700 hover:text-blue-900">Maintenance</a></li>
        <li><span class="text-gray-500">/</span></li>
        <li><span class="text-gray-900">{{ maintenance_request.request_number }}</span></li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ maintenance_request.title }}</h1>
            <p class="mt-1 text-sm text-gray-600">{{ maintenance_request.request_number }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'maintenance:maintenance_request_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-white bg-primary-500 hover:bg-primary-600 text-white">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to List
            </a>
        </div>
    </div>

    <!-- Status and Priority Badges -->
    <div class="flex space-x-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
            {% if maintenance_request.status == 'pending' %}bg-yellow-100 text-yellow-800
            {% elif maintenance_request.status == 'scheduled' %}bg-accent-100 text-blue-800
            {% elif maintenance_request.status == 'in_progress' %}bg-purple-100 text-purple-800
            {% elif maintenance_request.status == 'completed' %}bg-green-100 text-green-800
            {% elif maintenance_request.status == 'cancelled' %}bg-red-100 text-red-800
            {% else %}bg-gray-100 text-gray-800{% endif %}">
            {{ maintenance_request.get_status_display }}
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
            {% if maintenance_request.priority == 'urgent' %}bg-red-100 text-red-800
            {% elif maintenance_request.priority == 'high' %}bg-orange-100 text-orange-800
            {% elif maintenance_request.priority == 'medium' %}bg-yellow-100 text-yellow-800
            {% else %}bg-green-100 text-green-800{% endif %}">
            {{ maintenance_request.get_priority_display }} Priority
        </span>
    </div>

    <!-- Actions Section - Simplified -->
    {% if user.is_staff or user.is_superuser %}
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Actions</h3>
        </div>
        <div class="px-6 py-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                {% if maintenance_request.status == 'pending' %}
                <form method="post" action="{% url 'core_services:workflow_transition' 'maintenance' maintenance_request.id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="new_status" value="in_progress">
                    <input type="hidden" name="notes" value="Started work on maintenance request">
                    <button type="submit" class="group relative bg-white border-2 border-blue-200 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 hover:shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 active:bg-blue-100 w-full">
                        <div class="flex items-center justify-center mb-2">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l.707.707A1 1 0 0012.414 11H15m2 0h1.586a1 1 0 01.707.293l.707.707A1 1 0 0020.414 12H21"></path>
                            </svg>
                        </div>
                        <div class="text-sm font-semibold text-blue-900 text-center group-hover:text-blue-800">Start Work</div>
                    </button>
                </form>
                <form method="post" action="{% url 'core_services:workflow_transition' 'maintenance' maintenance_request.id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="new_status" value="cancelled">
                    <input type="hidden" name="notes" value="Request cancelled">
                    <button type="submit" class="group relative bg-white border-2 border-blue-200 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 hover:shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 active:bg-blue-100 w-full">
                        <div class="flex items-center justify-center mb-2">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <div class="text-sm font-semibold text-blue-900 text-center group-hover:text-blue-800">Cancel Request</div>
                    </button>
                </form>
                {% elif maintenance_request.status == 'in_progress' %}
                <form method="post" action="{% url 'core_services:workflow_transition' 'maintenance' maintenance_request.id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="new_status" value="completed">
                    <input type="hidden" name="notes" value="Request completed">
                    <button type="submit" class="group relative bg-white border-2 border-blue-200 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 hover:shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 active:bg-blue-100 w-full">
                        <div class="flex items-center justify-center mb-2">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div class="text-sm font-semibold text-blue-900 text-center group-hover:text-blue-800">Complete Request</div>
                    </button>
                </form>
                <form method="post" action="{% url 'core_services:workflow_transition' 'maintenance' maintenance_request.id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="new_status" value="cancelled">
                    <input type="hidden" name="notes" value="Request cancelled">
                    <button type="submit" class="group relative bg-white border-2 border-blue-200 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 hover:shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 active:bg-blue-100 w-full">
                        <div class="flex items-center justify-center mb-2">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <div class="text-sm font-semibold text-blue-900 text-center group-hover:text-blue-800">Cancel Request</div>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Request Details -->
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Request Details</h3>
        </div>
        <div class="px-6 py-4">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Tenant</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ maintenance_request.tenant.name }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Room</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ maintenance_request.room.room_number }} - {{ maintenance_request.room.location.name }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Requested By</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ maintenance_request.created_by.get_full_name }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Requested Date</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ maintenance_request.requested_date|date:"M d, Y g:i A" }}</dd>
                </div>
                {% if maintenance_request.scheduled_date %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Scheduled Date</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ maintenance_request.scheduled_date|date:"M d, Y g:i A" }}</dd>
                </div>
                {% endif %}
                {% if maintenance_request.completed_date %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Completed Date</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ maintenance_request.completed_date|date:"M d, Y g:i A" }}</dd>
                </div>
                {% endif %}
                {% if maintenance_request.actual_cost %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Actual Cost</dt>
                    <dd class="mt-1 text-sm text-gray-900">KES {{ maintenance_request.actual_cost|floatformat:2 }}</dd>
                </div>
                {% endif %}
                {% if maintenance_request.estimated_cost %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Estimated Cost</dt>
                    <dd class="mt-1 text-sm text-gray-900">KES {{ maintenance_request.estimated_cost|floatformat:2 }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>
    </div>

    <!-- Description -->
    {% if maintenance_request.description %}
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Description</h3>
        </div>
        <div class="px-6 py-4">
            <p class="text-sm text-gray-700 whitespace-pre-line">{{ maintenance_request.description }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Photos -->
    {% if maintenance_request.photo_urls %}
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Photos</h3>
        </div>
        <div class="px-6 py-4">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% for photo_url in maintenance_request.photo_urls %}
                <div class="aspect-square">
                    <img src="{{ photo_url }}" alt="Maintenance photo {{ forloop.counter }}" 
                         class="w-full h-full object-cover rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Additional Notes -->
    {% if maintenance_request.notes %}
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Additional Notes</h3>
        </div>
        <div class="px-6 py-4">
            <p class="text-sm text-gray-700 whitespace-pre-line">{{ maintenance_request.notes }}</p>
        </div>
    </div>
    {% endif %}

{% endblock %}
